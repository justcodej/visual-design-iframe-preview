!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("formily.reactive",["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Formily=e.Formily||{},e.Formily.Reactive={}))}(this,(function(e){"use strict";!function(){const e={NODE_ENV:"production"};try{if(process)return process.env=Object.assign({},process.env),void Object.assign(process.env,e)}catch(e){}globalThis.process={env:e}}();var t=Object.prototype.toString,r=function(e){return e&&e instanceof Map},n=function(e){return e&&e instanceof Set},a=function(e){return e&&e instanceof WeakMap},u=function(e){return e&&e instanceof WeakSet},o=function(e){return"function"==typeof e},i=Array.isArray,c=function(e){return"[object Object]"===t.call(e)},f=function(e){return r(e)||a(e)||n(e)||u(e)},l=function(e){return c(e)||i(e)},s=function(e){return Array.isArray(e)?e:null!=e?[e]:[]},v=function(){function e(e){void 0===e&&(e=[]),this.forEachIndex=0,this.value=e}return e.prototype.add=function(e){this.has(e)||this.value.push(e)},e.prototype.has=function(e){return this.value.indexOf(e)>-1},e.prototype.delete=function(e){var t=this.value.indexOf(e);t>-1&&(this.value.splice(t,1),t<=this.forEachIndex&&(this.forEachIndex-=1))},e.prototype.forEach=function(e){if(0!==this.value.length)for(this.forEachIndex=0;this.forEachIndex<this.value.length;this.forEachIndex++)e(this.value[this.forEachIndex])},e.prototype.batchDelete=function(e){if(0!==this.value.length)for(this.forEachIndex=0;this.forEachIndex<this.value.length;this.forEachIndex++){var t=this.value[this.forEachIndex];this.value.splice(this.forEachIndex,1),this.forEachIndex--,e(t)}},e.prototype.clear=function(){this.value.length=0},e}(),y=new WeakMap,p=new WeakMap,d=new WeakMap,h=new WeakMap,g=new WeakMap,b=[],k={value:0},m={value:0},O={value:!1},_={value:!1},w=new v,P=new v,E=new v,j=Symbol("MakeObservableSymbol"),x=new v,S=Symbol("iteration key"),R=function(e,t){var r=g.get(e),n=[];if(r){var a=r.get(t);a&&a.forEach((function(e){-1===n.indexOf(e)&&n.push(e)}))}return n},V=function(e,t){var r=R(e,t),n=m.value;m.value=0;for(var a=0,u=r.length;a<u;a++){var i=r[a];i._isComputed?i._scheduler(i):F()?P.add(i):z()?w.add(i):o(i._scheduler)?i._scheduler(i):i()}m.value=n},M=function(e){var t=e.key,r=e.type,n=e.target;"iterate"===r&&(t=S);var a=b[b.length-1];B()||a&&(_.value=!0,function(e,t){var r=e._reactionsSet;r?r.add(t):e._reactionsSet=new v([t])}(a,function(e,t,r){var n=g.get(e);if(n){var a=n.get(t);return a?a.add(r):n.set(t,new v([r])),n}var u=new Map([[t,new v([r])]]);return g.set(e,u),u}(n,t,a)))},I=function(e){var t=e.key,r=e.type,n=e.target,a=e.oldTarget;if(A(),function(e){x.forEach((function(t){return t(e)}))}(e),"clear"===r?a.forEach((function(e,t){V(n,t)})):V(n,t),"add"===r||"delete"===r||"clear"===r){var u=Array.isArray(n)?"length":S;V(n,u)}T()},D=function(e){var t;null===(t=e._reactionsSet)||void 0===t||t.forEach((function(t){t.forEach((function(t){t.delete(e)}))})),w.delete(e),P.delete(e),delete e._reactionsSet},q=function(e){e._disposed=!0,D(e),function(e){var t;null===(t=e._computesSet)||void 0===t||t.forEach((function(e){0===R(e._context,e._property).length&&(q(e),e._dirty=!0)}))}(e)},A=function(){k.value++},T=function(){if(k.value--,0===k.value){var e=m.value;m.value=0,K(),Y(),m.value=e}},W=function(){O.value=!0},N=function(){var e=m.value;O.value=!1,m.value=0,P.batchDelete((function(e){o(e._scheduler)?e._scheduler(e):e()})),m.value=e},C=function(){m.value++},J=function(){m.value--},z=function(){return k.value>0},F=function(){return O.value},B=function(){return m.value>0},K=function(){w.batchDelete((function(e){o(e._scheduler)?e._scheduler(e):e()}))},Y=function(){E.batchDelete((function(e){e()}))},$=function(e,t){return e!==t&&(e.length!==t.length||!!e.some((function(e,r){return e!==t[r]})))},L=function(){return L=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},L.apply(this,arguments)};function G(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,u=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=u.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=u.return)&&r.call(u)}finally{if(a)throw a.error}}return o}function H(e,t){for(var r=0,n=t.length,a=e.length;r<n;r++,a++)e[a]=t[r];return e}var Q,U=function(){function e(e,t){this.node=t,this.key=e.key,this.type=e.type,this.object=e.target,this.value=e.value,this.oldValue=e.oldValue}return Object.defineProperty(e.prototype,"path",{get:function(){return this.node.path.concat(this.key)},enumerable:!1,configurable:!0}),e}(),X=function(){function e(e,t,r){this.target=e,this.key=t,this.value=r}return Object.defineProperty(e.prototype,"path",{get:function(){return this.parent?this.parent.path.concat(this.key):this.key?[this.key]:[]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"targetRaw",{get:function(){return y.get(this.target)||this.target},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){if(this.target)return Z(this.targetRaw)},enumerable:!1,configurable:!0}),e.prototype.isEqual=function(e){return this.key?e.targetRaw===this.targetRaw&&e.key===this.key:e.value===this.value},e.prototype.contains=function(e){if(e===this)return!0;for(var t=e.parent;t;){if(this.isEqual(t))return!0;t=t.parent}return!1},e}(),Z=function(e){return h.get(e)},ee=function(e,t){h.set(e,t)},te=function(e,t,r){var n=y.get(r)||r,a=Z(n);if(a)return a;ee(n,new X(e,t,r))},re=Symbol("RAW_TYPE"),ne=Symbol("OBSERVABLE_TYPE"),ae=Object.prototype.hasOwnProperty,ue=function(e){return y.has(e)},oe=function(e){return e&&!!e[j]},ie=function(e){return null!=e&&(!!i(e)||(c(e)?!e[re]&&(!!e[ne]||(!("$$typeof"in e)||!("_owner"in e))&&(!e._isAMomentObject&&(!e._isJSONSchemaObject&&(!o(e.toJS)&&!o(e.toJSON))))):!!(r(e)||a(e)||n(e)||u(e))))},ce=new Set(Object.getOwnPropertyNames(Symbol).map((function(e){return Symbol[e]})).filter((function(e){return"symbol"==typeof e}))),fe=Object.prototype.hasOwnProperty;function le(e,t,r){var n=p.get(r);return n||(!ue(r)&&ie(r)?ge(e,t,r):r)}function se(e,t,r,n){var a=r.next;return r.next=function(){var u=a.call(r),o=u.done,i=u.value;return o||(n?i[1]=le(e,t,i[1]):i=le(e,t,i)),{done:o,value:i}},r}var ve=(Q={has:function(e){var t=y.get(this),r=Reflect.getPrototypeOf(this);return M({target:t,key:e,type:"has"}),r.has.apply(t,arguments)},get:function(e){var t=y.get(this),r=Reflect.getPrototypeOf(this);return M({target:t,key:e,type:"get"}),le(t,e,r.get.apply(t,arguments))},add:function(e){var t=y.get(this),r=Reflect.getPrototypeOf(this),n=r.has.call(t,e),a=r.add.apply(t,arguments);return n||I({target:t,key:e,value:e,type:"add"}),a},set:function(e,t){var r=y.get(this),n=Reflect.getPrototypeOf(this),a=n.has.call(r,e),u=n.get.call(r,e),o=n.set.apply(r,arguments);return a?t!==u&&I({target:r,key:e,value:t,oldValue:u,type:"set"}):I({target:r,key:e,value:t,type:"add"}),o},delete:function(e){var t=y.get(this),r=Reflect.getPrototypeOf(this),n=r.has.call(t,e),a=r.get?r.get.call(t,e):void 0,u=r.delete.apply(t,arguments);return n&&I({target:t,key:e,oldValue:a,type:"delete"}),u},clear:function(){var e=y.get(this),t=Reflect.getPrototypeOf(this),r=0!==e.size,n=e instanceof Map?new Map(e):new Set(e),a=t.clear.apply(e,arguments);return r&&I({target:e,oldTarget:n,type:"clear"}),a},forEach:function(e){for(var t,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var a=y.get(this),u=Reflect.getPrototypeOf(this);M({target:a,type:"iterate"});var o=function(t,r){for(var n=[],u=2;u<arguments.length;u++)n[u-2]=arguments[u];return e.apply(void 0,H([le(a,r,t),r],G(n)))};return(t=u.forEach).call.apply(t,H([a,o],G(r)))},keys:function(){var e=y.get(this),t=Reflect.getPrototypeOf(this);return M({target:e,type:"iterate"}),t.keys.apply(e,arguments)},values:function(){var e=y.get(this),t=Reflect.getPrototypeOf(this);M({target:e,type:"iterate"});var r=t.values.apply(e,arguments);return se(e,"",r,!1)},entries:function(){var e=y.get(this),t=Reflect.getPrototypeOf(this);M({target:e,type:"iterate"});var r=t.entries.apply(e,arguments);return se(e,"",r,!0)}},Q[Symbol.iterator]=function(){var e=y.get(this),t=Reflect.getPrototypeOf(this);M({target:e,type:"iterate"});var r=t[Symbol.iterator].apply(e,arguments);return se(e,"",r,e instanceof Map)},Object.defineProperty(Q,"size",{get:function(){var e=y.get(this),t=Reflect.getPrototypeOf(this);return M({target:e,type:"iterate"}),Reflect.get(t,"size",e)},enumerable:!1,configurable:!0}),Q),ye={get:function(e,t,r){return e=fe.call(ve,t)?ve:e,Reflect.get(e,t,r)}},pe={get:function(e,t,r){if(t){var n=e[t];if("symbol"==typeof t&&ce.has(t))return n;M({target:e,key:t,receiver:r,type:"get"});var a=p.get(n);if(a)return a;if(!ue(n)&&ie(n)){var u=Reflect.getOwnPropertyDescriptor(e,t);if(!u||!1!==u.writable||!1!==u.configurable)return ge(e,t,n)}return n}},has:function(e,t){var r=Reflect.has(e,t);return M({target:e,key:t,type:"has"}),r},ownKeys:function(e){var t=Reflect.ownKeys(e);return M({target:e,type:"iterate"}),t},set:function(e,t,r,n){var a=fe.call(e,t),u=ge(e,t,r),o=e[t];return e[t]=u,a?r!==o&&I({target:e,key:t,value:u,oldValue:o,receiver:n,type:"set"}):I({target:e,key:t,value:u,oldValue:o,receiver:n,type:"add"}),!0},deleteProperty:function(e,t){var r=e[t];return delete e[t],I({target:e,key:t,oldValue:r,type:"delete"}),!0}},de=function(e,t){var r=new Proxy(e,pe);return y.set(r,e),t?d.set(e,r):p.set(e,r),r},he=function(e,t){var r=new Proxy(e,ye);return y.set(r,e),t?d.set(e,r):p.set(e,r),r},ge=function(e,t,r,n){if("object"!=typeof r)return r;var a=y.get(r);if(a){var u=Z(a);return u.target||(u.target=e),u.key=t,r}if(!ie(r))return r;if(e){var o=y.get(e)||e;if(d.get(o))return r}return te(e,t,r),n?function(e){return l(e)?de(e,!0):f(e)?he(e,!0):e}(r):l(r)?de(r):f(r)?he(r):r},be=function(e){var t=function(t){return e({value:t})};return o(e)&&(t[j]=e),t},ke=function(e){if(e[j])return e[j][j]?ke(e[j]):e[j]},me=function(e,t){function r(r){var n;try{e(),o(r)&&(n=r())}finally{t()}return n}return r.bound=Oe(r),r},Oe=function(e){return function(t,r){return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];return e((function(){return t.apply(r,n)}))}}},_e=function(e,t){var r=me(e,t),n=be((function(e){var t=e.target,n=e.key;return t[n]=r.bound(t[n],t),t}));return r[j]=n,r.bound[j]=n,r},we=_e(A,T);we.scope=_e(W,N),we.endpoint=function(e){o(e)&&(0===k.value?e():E.add(e))};var Pe=_e((function(){A(),C()}),(function(){J(),T()}));Pe.scope=_e((function(){W(),C()}),(function(){J(),N()}));var Ee=me(C,J),je=be((function(e){var t=e.target,r=e.key,n=e.value,a={value:ge(t,r,t?t[r]:n)};return t?(Object.defineProperty(t,r,{set:function(e){var n=a.value;e=ge(t,r,e),a.value=e,n!==e&&I({target:t,key:r,type:"set",oldValue:n,value:e})},get:function(){return M({target:t,key:r,type:"get"}),a.value},enumerable:!0,configurable:!1}),t):a.value})),xe=be((function(e){var t=e.target,r=e.key,n=e.value,a={value:t?t[r]:n},u={set:function(e){var t=a.value;a.value=e,t!==e&&I({target:a,key:r,type:"set",oldValue:t,value:e})},get:function(){return M({target:a,key:r,type:"get"}),a.value}};return y.set(u,a),p.set(a,u),te(t,r,a),t?(Object.defineProperty(t,r,{value:u,enumerable:!0,configurable:!1,writable:!1}),t):u})),Se=be((function(e){var t=e.target,r=e.key,n=e.value,a={value:t?t[r]:n},u={},o=t||a,i=t?r:"value";function c(){return M({target:o,key:i,type:"get"}),a.value}function f(e){var t=a.value;a.value=e,t!==e&&I({target:o,key:i,type:"set",oldValue:t,value:e})}return t?(Object.defineProperty(t,r,{get:c,set:f,enumerable:!0}),t):(Object.defineProperty(u,"value",{set:f,get:c}),te(t,r,a),y.set(u,a),p.set(a,u),u)})),Re=be((function(e){var t=e.target,r=e.key,n=e.value,a={value:ge(t,r,t?t[r]:n,!0)};return t?(Object.defineProperty(t,r,{set:function(e){var n=a.value;e=ge(t,r,e,!0),a.value=e,n!==e&&I({target:t,key:r,type:"set",oldValue:n,value:e})},get:function(){return M({target:t,key:r,type:"get"}),a.value},enumerable:!0,configurable:!1}),t):a.value})),Ve=Object.getOwnPropertyDescriptor,Me=Object.getPrototypeOf,Ie=new WeakMap;function De(e,t){if(e)return Ve(e,t)||De(Me(e),t)}function qe(e,t,r){if(!e)return r?o(r)?{get:r}:r:{};var n=function(e,t){var r=e.constructor;if(r===Object||r===Array)return De(e,t);var n=Ie.get(r)||{},a=n[t];if(a)return a;var u=De(e,t);return Ie.set(r,n),n[t]=u,u}(e,t);return n||{}}var Ae=be((function(e){var t=e.target,r=e.key,n=e.value,a={},u={},i=t||a,c=t?r:"value",f=qe(t,c,n);function l(){var e;a.value=null===(e=f.get)||void 0===e?void 0:e.call(i)}function s(){if(-1===b.indexOf(s)){D(s);try{b.push(s),l()}finally{b.pop()}}}function d(){return b.length>0&&function(e){if(o(e)){var t=b[b.length-1];if(t){var r=t._computesSet;r?r.add(e):t._computesSet=new v([e])}}}(s),B()?l():s._dirty&&(s(),s._dirty=!1),M({target:i,key:c,type:"get"}),a.value}function h(e){var t;try{A(),null===(t=f.set)||void 0===t||t.call(i,e)}finally{T()}}return s._name="ComputedReaction",s._scheduler=function(){s._dirty=!0,I({target:i,key:c,value:a.value,type:"set"})},s._isComputed=!0,s._dirty=!0,s._context=i,s._property=c,t?(Object.defineProperty(t,r,{get:d,set:h,enumerable:!0}),t):(Object.defineProperty(u,"value",{set:h,get:d}),te(t,r,a),y.set(u,a),p.set(a,u),u)}));function Te(e){return ge(null,null,e)}function We(e,t){if(ue(e))return e;if(!ie(e))return e;for(var r in te(void 0,void 0,e),y.set(e,e),p.set(e,e),t){var n=t[r];oe(n)&&ke(n)({target:e,key:r})}return e}Te.box=xe,Te.ref=Se,Te.deep=je,Te.shallow=Re,Te.computed=Ae,Te[j]=je;var Ne=function(e,t){void 0===t&&(t="AutoRun");var r=function(){if(o(e)&&!(r._boundary>0)&&-1===b.indexOf(r)){D(r);try{A(),b.push(r),e()}finally{b.pop(),r._boundary++,T(),r._boundary=0,r._memos.cursor=0,r._effects.cursor=0}}},n=function(){r._memos={queue:[],cursor:0},r._effects={queue:[],cursor:0}};return r._boundary=0,r._name=t,n(),r(),function(){q(r),function(e){if(e._effects)try{A(),e._effects.queue.forEach((function(e){e&&e.dispose&&e.dispose()}))}finally{T()}}(r),n()}};Ne.memo=function(e,t){if(o(e)){var r=b[b.length-1];if(!r||!r._memos)throw new Error("autorun.memo must used in autorun function body.");var n=s(t||[]),a=r._memos.cursor++,u=r._memos.queue[a];if(!u||$(n,u.deps)){var i=e();return r._memos.queue[a]={value:i,deps:n},i}return u.value}},Ne.effect=function(e,t){if(o(e)){var r=b[b.length-1];if(!r||!r._effects)throw new Error("autorun.effect must used in autorun function body.");var n=r._effects,a=s(t||[{}]),u=n.cursor++,i=n.queue[u];i&&!$(a,i.deps)||(Promise.resolve(0).then((function(){if(!r._disposed){var t=e();o(t)&&(n.queue[u].dispose=t)}})),n.queue[u]={deps:a})}};var Ce=function(e,t){void 0===t&&(t="TrackerReaction");var r=this;this.track=function(e){if(!o(e))return r.results;if(!(r.track._boundary>0)){if(-1===b.indexOf(r.track)){D(r.track);try{A(),b.push(r.track),r.results=e()}finally{b.pop(),r.track._boundary++,T(),r.track._boundary=0}}return r.results}},this.dispose=function(){q(r.track)},this.track._scheduler=function(t){0===r.track._boundary&&r.dispose(),o(t)&&e(t)},this.track._name=t,this.track._boundary=0};e.DataChange=U,e.DataNode=X,e.Tracker=Ce,e.action=Pe,e.autorun=Ne,e.batch=we,e.buildDataTree=te,e.contains=function(e,t){var r=y.get(e)||e,n=y.get(t)||t;if(r===n)return!0;var a=Z(r),u=Z(n);return!!a&&(!!u&&a.contains(u))},e.define=We,e.getDataNode=Z,e.hasCollected=function(e){return _.value=!1,null==e||e(),_.value},e.isAnnotation=oe,e.isObservable=ue,e.isSupportObservable=ie,e.markObservable=function(e){if(e)return o(e)?e.prototype[ne]=!0:e[ne]=!0,e},e.markRaw=function(e){if(e)return o(e)?e.prototype[re]=!0:e[re]=!0,e},e.model=function(e){var t=Object.keys(e||{}).reduce((function(t,r){var n=Object.getOwnPropertyDescriptor(e,r);return n&&n.get?t[r]=Te.computed:o(e[r])?t[r]=Pe:t[r]=Te,t}),{});return We(e,t)},e.observable=Te,e.observe=function(e,t,r){void 0===r&&(r=!0);if(e&&"object"!=typeof e)throw Error("Can not observe ".concat(typeof e," type."));return function(e){var n=y.get(e)||e,a=Z(n),u=function(e){var n=y.get(e.target)||e.target,u=Z(n);(r&&a.contains(u)||a===u||a.targetRaw===n&&a.key===e.key)&&t(new U(e,u))};return a&&o(t)&&x.add(u),function(){x.delete(u)}}(e)},e.raw=function(e){return y.get(e)},e.reaction=function(e,t,r){var n=L({name:"Reaction"},r),a={},u=function(){try{A(),o(t)&&t(a.currentValue,a.oldValue)}finally{T()}},i=function(){if(-1===b.indexOf(i)){D(i);try{b.push(i),a.currentValue=e()}finally{b.pop()}}};return i._scheduler=function(e){e(),(o(n.equals)?n.equals(a.oldValue,a.currentValue):a.oldValue===a.currentValue)||u(),a.oldValue=a.currentValue},i._name=n.name,i(),a.oldValue=a.currentValue,n.fireImmediately&&u(),function(){q(i)}},e.setDataNode=ee,e.toJS=function(e){var t=new WeakSet,r=function(e){if(t.has(e))return e;if(e&&e[re])return e;if(i(e)){if(ue(e)){t.add(e);var n=[];return e.forEach((function(e){n.push(r(e))})),t.delete(e),n}}else if(c(e)&&ue(e)){t.add(e);var a={};for(var u in e)ae.call(e,u)&&(a[u]=r(e[u]));return t.delete(e),a}return e};return r(e)},e.untracked=Ee,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=formily.reactive.umd.production.js.map
